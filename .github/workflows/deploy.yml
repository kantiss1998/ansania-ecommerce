name: Build and Deploy to cPanel

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install dependencies
        run: npm install

      - name: Build and Bundle projects
        run: |
          npx turbo run build --filter=web --filter=api --force
          npx turbo run bundle --filter=api --force

      - name: Prepare Web Standalone
        run: |
          mkdir -p deploy/web
          # Copy dependencies first (root level of standalone output)
          cp -R apps/web/.next/standalone/node_modules deploy/web/
          
          # Copy application code (nested inside apps/web)
          cp apps/web/.next/standalone/apps/web/server.js deploy/web/
          cp apps/web/.next/standalone/apps/web/package.json deploy/web/
          cp -R apps/web/.next/standalone/apps/web/.next deploy/web/
          
          # Copy public and static assets to correct location
          cp -R apps/web/public deploy/web/public
          mkdir -p deploy/web/.next/static
          cp -R apps/web/.next/static/. deploy/web/.next/static/
          
          # Verify content before upload
          echo "Listing deploy/web content:"
          ls -la deploy/web

      - name: Prepare API Bundle
        run: |
          mkdir -p deploy/api
          cp apps/api/dist/index.js deploy/api/
          node -e "const pkg=require('./apps/api/package.json'); delete pkg.dependencies; delete pkg.devDependencies; require('fs').writeFileSync('./deploy/api/package.json', JSON.stringify(pkg, null, 2))"

      # Deploy Web to cPanel
      - name: Deploy Web to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          local-dir: ./deploy/web/
          server-dir: ${{ secrets.FTP_WEB_ROOT }}/
          protocol: ftp

      # Deploy API to cPanel
      - name: Deploy API to cPanel
        uses: SamKirkland/FTP-Deploy-Action@v4.3.5
        with:
          server: ${{ secrets.FTP_SERVER }}
          username: ${{ secrets.FTP_USERNAME }}
          password: ${{ secrets.FTP_PASSWORD }}
          port: ${{ secrets.FTP_PORT || 21 }}
          local-dir: ./deploy/api/
          server-dir: ${{ secrets.FTP_API_ROOT }}/
          protocol: ftp
